## specification

The purpose of this document is to specify exactly the requirements and
behaviours of a project using the lambda pattern.

This specification has been written with some details specifically pertaining to
javascript development.


### jargon

#### lambda pattern

The lambda pattern is a set of prescribed organisations and behaviours for a
lambda pattern project. The most important principle of the lambda pattern is to
have a src folder and a gen folder. The src folder is as human editable as
possible. The gen folder should not be edited. It should be generated by the
lambda pattern tool. Apart from the gen/stored folder, the contents of the gen
folder should be able to be deleted and regenerated easily from the src
directory. Apart from automatic incremental builds, normal procedure should be
to do a clean build each time by removing all data from the gen/dev folder apart
from files specified in gen/dev/cached.

#### lambda pattern project

A lambda pattern project follows the lambda pattern.

#### lambda source

The lambda source is the src folder inside a lambda pattern project.

#### lambda pattern tool

A command line tool which is used for creating and maintaining a lambda pattern
project.

The source code for the lambda pattern tool is a lambda pattern project
itself.

#### lambda pattern skeleton

The basic outline of the project which is not updated by the lambda pattern
tool.

This is the skeleton for an es6 lambda pattern project:

```
root
├── gen
│   ├── stored
│   │   ├── lambda_state_history.yaml
│   │   └── tools.js
│   └── .gitignore // dev
├── src
│   ├── [project name]
│   │   ├── [project_name.es6]
│   │   ├── [project_name_test.es6]
│   │   ├── npm_dependencies
│   │   └── npm_dev_dependencies
│   └── tools
│       ├── build_test_data
│       │   ├── after1
│       │   ├── before1
│       │   └── dependency
│       ├── modify_tools.es6
│       ├── tools_tests.es6
│       ├── metadata.yaml
│       ├── paths.yaml // es6, cached, gitignore (...: dev: , release: )
│       └── tools_npm_dev_dependencies.yaml
├── LICENCE.md
└── README.md
```

Here is an example of a project after being developed and built:

```
root
├── gen
│   ├── dev
│   │   ├── [project name]
│   │   │   ├── node_packages
│   │   │   │   ├── ...
│   │   │   │   '
│   │   │   ├── [project name.js]
│   │   │   ├── [project name_test.js]
│   │   │   └── package.json
│   ├── stored
│   │   ├── lambda_state_history.yaml
│   │   └── tools.js
│   └── .gitignore // dev
├── src
│   ├── [project name]
│   │   ├── [project_name.es6]
│   │   ├── [project_name_test.es6]
│   │   ├── npm_dependencies
│   │   ├── metadata.yaml
│   │   └── npm_dev_dependencies.yaml
│   └── tools
│       ├── build_test_data
│       │   ├── after1
│       │   ├── before1
│       │   └── dependency
│       ├── modify_tools.es6
│       ├── tools_tests.es6
│       ├── paths.yaml
│       └── tools_npm_dev_dependencies.yaml
├── LICENCE.md
└── README.md
```

#### lambda pattern updatables

A set of files that are created by the lambda pattern tool at a particular
updatables version number. Lambda pattern projects should keep the version
number as recent as possible.

The updatables exist in a repository (for example 'lambda pattern updatables
es6') and the updatables version number is a revision number for that repo. Most
of the behavior of the lambda pattern tool for building is specified in the
updatables repo, so that old lambda pattern projects don't break.

#### lambda state

The lambda state is the details of how the project tools operate. Modifying the
lambda state will potentially prevent the project from building correctly. The
lambda state comprises two pieces: the tools.js file and the updatables folder
at a particular revision number. Each change to the lambda state is stored along
with a record of the revision number when most recently a full dev / release
test was completely successful.


## commands

### managing projects

#### create [name]

* create a folder called [name]
* set up the skeleton inside the folder
* check out the updatables repo into gen/.updatables
* add the project path to the ~/.lambda file

#### get [name]

* attempts to check out the project from github, otherwise bitbucket
* runs build dev on the project

#### close [name]

* deletes the named repo and removes it from the ~/.lambda file

### building and testing

before each of the following steps:
* make sure the gen/.updatables folder exists and fits the expected version
* make a symlink from gen/stored/tools_scripts/current.js to
    gen/tools.js

#### build dev

* run the tools.build.dev(path) function by requiring gen/tools.js, passing the
    root folder as a parameter
    * deletes the folder gen/dev/src
    * copies from src to gen/dev/src
    * installs npm modules
    * compiles all the source files in place in gen/dev/src

#### build single dev

* similar to build dev but only acts on a single file (map from globs to
    functions)

#### build release

* run the tools.build.release(path) function by requiring gen/tools.js, passing
    the root folder as a parameter
    * deletes the folder gen/release/src
    * copies from src to gen/release/src
    * installs npm modules
    * compiles all source in place in gen/release/src and cleans up
    * copies the licence and readme from root into gen/release

#### build single release

* similar to build release but only acts on a single file (map from globs to
    functions)

#### test dev

* run the tools.test.dev(path) function by requiring gen/tools.js, passing the
    root folder as a paramter
    * run all files which end with \_test.js in the gen/dev folder
    * write the results into gen/dev/test_results
    * if the tests have zero fails, write the current version number into the
        correct gen/stored/lambda_state_history.yaml entry

#### update tools

* copy the gen/tools.js file from the to
    gen/stored/tools/version_number.js
* write a new version number into gen/stored/lambda_state_history.yaml

#### test single dev

* similar to test dev but only acts on tests in the folder of a given file

#### test release

* run the tools.test.dev(path) function by requiring gen/tools.js, passing the
    root folder as a paramter
    * run all files which end with \_test.js but not \_dev_test.js in the
        gen/release folder
    * write the results into gen/dev/test_results
    * if the tests have zero fails, write the current version number into the
        correct gen/stored/lambda_state_history.yaml entry

#### test single release

* similar to test release but only acts on tests in the folder of a given file

#### publish

* updates the version number
* performs a release build
* performs a commit and push
* publishes the new repo to the package manager database


### other commands

#### update updatables

* performs a git pull on the gen/.updatables directory
* if a specific revision number is given, performs a checkout of that revision
* creates a new lambda state history entry

#### overwrite tools

* moves the gen/stored/tools_scripts/current.js file to the same folder but
    with the current lambda state number as the filename
* concats all js files in the gen/dev/lambda folder, using the tools.js file as
    an entry point
* writes this file to gen/stored/tools_scripts/current.js
* create a new lambda state history entry

#### set lambda state version

* perform a checkout of the correct updatables version
* move the gen/stored/tools_scripts/current.js file to the same folder but with
    the current lambda state number as the filename
* move the gen/stored/tools_scripts/??.js file to the same folder but with the
    filename current.js

#### name lambda state

* sets the name of the current lambda state

#### add folder

* adds a new folder with the given name into gen/stored/[project name]
* add an es6 file and \_test.es6 file into this folder with default contents


### lambda demon (lambdad)

#### start

* if it is not already running, starts the lambda demon
* begins watching all of the repos in ~/.lambda for changes
* when changes occur, runs build single dev, build single release, test single dev,
    test single release

#### stop

* kills the lambda demon
